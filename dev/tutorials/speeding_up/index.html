<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Speeding Up PDDL.jl · PDDL.jl</title><meta name="title" content="Speeding Up PDDL.jl · PDDL.jl"/><meta property="og:title" content="Speeding Up PDDL.jl · PDDL.jl"/><meta property="twitter:title" content="Speeding Up PDDL.jl · PDDL.jl"/><meta name="description" content="How to compile PDDL domains to speed up PDDL.jl."/><meta property="og:description" content="How to compile PDDL domains to speed up PDDL.jl."/><meta property="twitter:description" content="How to compile PDDL domains to speed up PDDL.jl."/><meta property="og:url" content="https://juliaplanners.github.io/PDDL.jl/stable/tutorials/speeding_up/"/><meta property="twitter:url" content="https://juliaplanners.github.io/PDDL.jl/stable/tutorials/speeding_up/"/><link rel="canonical" href="https://juliaplanners.github.io/PDDL.jl/stable/tutorials/speeding_up/"/><meta property="og:image" content="https://juliaplanners.github.io/PDDL.jl/stable/assets/preview.png"/><meta property="twitter:image" content="https://juliaplanners.github.io/PDDL.jl/stable/assets/preview.png"/><meta property="twitter:card" content="summary_large_image"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/logo.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="PDDL.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PDDL.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">PDDL.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../getting_started/">Getting Started</a></li><li><a class="tocitem" href="../writing_planners/">Writing Planners</a></li><li class="is-active"><a class="tocitem" href>Speeding Up PDDL.jl</a><ul class="internal"><li><a class="tocitem" href="#Using-the-Compiler"><span>Using the Compiler</span></a></li><li><a class="tocitem" href="#State-Compilation"><span>State Compilation</span></a></li><li><a class="tocitem" href="#Action-Compilation"><span>Action Compilation</span></a></li><li><a class="tocitem" href="#Compiler-Limitations"><span>Compiler Limitations</span></a></li></ul></li><li><a class="tocitem" href="../extending/">Extending PDDL.jl</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../ref/overview/">Architecture Overview</a></li><li><a class="tocitem" href="../../ref/datatypes/">Concepts and Data Types</a></li><li><a class="tocitem" href="../../ref/interface/">Interface Functions</a></li><li><a class="tocitem" href="../../ref/parser_writer/">Parser and Writer</a></li><li><a class="tocitem" href="../../ref/interpreter/">Interpreter</a></li><li><a class="tocitem" href="../../ref/compiler/">Compiler</a></li><li><a class="tocitem" href="../../ref/absint/">Abstract Interpretation</a></li><li><a class="tocitem" href="../../ref/utilities/">Utilities</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Speeding Up PDDL.jl</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Speeding Up PDDL.jl</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaPlanners/PDDL.jl" title="View the repository on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaPlanners/PDDL.jl/blob/master/docs/src/tutorials/speeding_up.md" title="Edit source on GitHub"><span class="docs-icon fas"></span></a><a class="docs-settings-button docs-navbar-link fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button docs-navbar-link fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Speeding-Up-PDDL.jl"><a class="docs-heading-anchor" href="#Speeding-Up-PDDL.jl">Speeding Up PDDL.jl</a><a id="Speeding-Up-PDDL.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Speeding-Up-PDDL.jl" title="Permalink"></a></h1><p>By default, PDDL.jl uses the <a href="../../ref/interpreter/">built-in PDDL interpreter</a> to execute actions, determine the set of available actions, and perform other basic planning operations. However, because the interpreter is not optimized for speed, planning algorithms that use the interpreter are considerably slower than state-of-the-art planners.</p><figure style="text-align:center">
    <img src="../../assets/performance-comparison.svg" alt="Blocksworld solution runtimes vs. problem size for PDDL.jl, Pyperplan, and FastDownward, each using A* search with the additive heuristic." width="80%"/>
    <figcaption>Blocksworld solution times for PDDL.jl vs. baselines, each using A* search with the additive heuristic.</figcaption>
</figure><p>Fortunately, PDDL.jl also provides <a href="../../ref/compiler/">a PDDL compiler</a> that is optimized for speed and low memory consumption. As can be seen in the (log-scale) graph above, using the compiler to solve Blocksworld problems is 10 times faster than the interpreter, within an order of magnitude of the state-of-the-art <a href="https://www.fast-downward.org/">FastDownward</a> planner, and 20 times faster than <a href="https://github.com/aibasel/pyperplan">Pyperplan</a>, a Python-based planning system. In this tutorial, we show how to use the PDDL compiler to speed up planning algorithms, and explain how these speed-ups are achieved.</p><h2 id="Using-the-Compiler"><a class="docs-heading-anchor" href="#Using-the-Compiler">Using the Compiler</a><a id="Using-the-Compiler-1"></a><a class="docs-heading-anchor-permalink" href="#Using-the-Compiler" title="Permalink"></a></h2><p>To use the PDDL compiler, just call the <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> function on a PDDL domain and problem. This returns a compiled domain and initial state:</p><pre><code class="language-julia hljs">using PDDL, PlanningDomains

# Load a generic representation of PDDL domain and problem
domain = load_domain(:blocksworld)
problem = load_problem(:blocksworld, &quot;problem-10&quot;)

# Compile the domain and problem to get a compiled domain and state
c_domain, c_state = compiled(domain, problem)</code></pre><p>Alternatively, <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> can be called on a non-compiled domain and (initial) state:</p><pre><code class="language-julia hljs"># Construct initial state from domain and problem
state = initstate(domain, problem)

# Compile the domain and state to get a compiled domain and state
c_domain, c_state = compiled(domain, state)</code></pre><p>The compiled outputs <code>c_domain</code> and <code>c_state</code> can then be used with the <a href="../../ref/interpreter/">PDDL.jl interface</a>, or with <a href="../writing_planners/#Existing-Planners">an existing planner from SymbolicPlanners.jl</a>:</p><pre><code class="language-julia hljs">using SymbolicPlanners

# Call A* search on compiled domain and initial state
goal = PDDL.get_goal(problem)
planner = AStarPlanner(HAdd())
sol = planner(c_domain, c_state, goal)

# Execute resulting plan on the compiled initial state
plan = collect(sol)
for act in plan
    c_state = transition(c_domain, c_state, act)
end

# Check that the goal is achieved in the final state
@assert satisfy(c_domain, c_state, goal)</code></pre><p>Factoring out the initial cost of <a href="https://discourse.julialang.org/t/so-does-julia-compile-or-interpret/56073/2?u=xuan">Julia&#39;s just-ahead-of-time compilation</a>, planning over the compiled domain and state should lead to runtimes that are 10 times faster or more, compared to the PDDL.jl interpreter.</p><h2 id="State-Compilation"><a class="docs-heading-anchor" href="#State-Compilation">State Compilation</a><a id="State-Compilation-1"></a><a class="docs-heading-anchor-permalink" href="#State-Compilation" title="Permalink"></a></h2><p>One way in which the PDDL.jl compiler reduces runtime is by generating <em>compiled state representations</em> that compactly represent the set of facts and fluent values in a state.  These representations take advantage of the fixed number of objects in standard PDDL problems, allowing for the generation of finite-object state representations with a known size in advance.</p><p>To illustrate the benefits of state compilation, consider the initial state of a Blocksworld problem with 3 blocks, as shown in the <a href="../getting_started/#Loading-Domains-and-Problems">Getting Started</a> tutorial. The generic state representation used by the PDDL.jl interpreter stores all Boolean fluents in a <code>Set</code> data structure, and non-Boolean fluents in a <code>Dict</code>. This consumes a fair amount of memory, and suffers from hashing overhead when looking up the value of a fluent:</p><pre><code class="nohighlight hljs">GenericState
    types -&gt; Set{Compound} with 3 elements
       pddl&quot;(block a)&quot;,
       pddl&quot;(block b)&quot;,
       pddl&quot;(block c)&quot;
    facts -&gt; Set{Term} with 7 elements
       pddl&quot;(handempty)&quot;,
       pddl&quot;(clear a)&quot;,
       pddl&quot;(clear b)&quot;,
       pddl&quot;(clear c)&quot;
       pddl&quot;(ontable a)&quot;,
       pddl&quot;(ontable b)&quot;,
       pddl&quot;(ontable c)&quot;
    values -&gt; Dict{Term,Any} with 0 entries

Size: 1720 bytes
Median Access Time: 394 ns</code></pre><p>In constrast, the compiled state representation is shown below. Predicate values are stored in memory-efficient bit-arrays, with dimensionality corresponding to the arity of each predicate (1 dimension for <code>(holding ?x)</code>, 2 dimensions for <code>(on ?x ?y)</code>). Furthermore, each bit array is a field with a fixed name in the compiled data structure. Together, this leads to much lower memory consumption and access times:</p><pre><code class="nohighlight hljs">CompiledBlocksworldState
    handempty -&gt;
        true
    clear -&gt; 3-element BitVector
        1  1  1
    holding -&gt; 3-element BitVector
        0  0  0
    ontable -&gt; 3-element BitVector
        1  1  1
    on -&gt; 3x3 BitMatrix
        0  0  0
        0  0  0
        0  0  0

Size: 336 bytes
Median Access Time: 58.5 ns</code></pre><p>Generating a compiled state representation requires knowing the number of objects in the problem, their types, and their names. This is why the <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> function requires either the problem or initial state as an input.</p><h2 id="Action-Compilation"><a class="docs-heading-anchor" href="#Action-Compilation">Action Compilation</a><a id="Action-Compilation-1"></a><a class="docs-heading-anchor-permalink" href="#Action-Compilation" title="Permalink"></a></h2><p>PDDL.jl also supports <em>compiled action semantics</em>, generating specialized implementations of the <a href="../../ref/interface/#PDDL.execute"><code>execute</code></a> and <a href="../../ref/interface/#PDDL.available-Tuple{Domain, State, Action, Any}"><code>available</code></a> interface functions for each action schema in the domain. This makes use of Julia&#39;s support for multiple dispatch: By generating concrete subtypes of the <a href="../../ref/datatypes/#PDDL.Action"><code>Action</code></a> datatype for each action schema, specialized methods can be defined for each subtype.</p><p>As an example, consider the compiled implementation of <a href="../../ref/interface/#PDDL.execute"><code>execute</code></a> for the <code>(stack ?x ?y)</code> action in the Blocksworld domain. Instead of interpreting the effect formula associated with the action each time it is executed, the compiled version of <a href="../../ref/interface/#PDDL.execute"><code>execute</code></a> directly modifies the appropriate entries of the compiled state representation for the Blocksworld domain (shown below with comments):</p><pre><code class="language-julia hljs">function execute(domain, state, action::CompiledStackAction, args)
    state = copy(state)
    # Get object indices for arguments
    x_idx = objectindex(state, :block, args[1].name)
    y_idx = objectindex(state, :block, args[2].name)
    # Assign new values to affected fluents
    state.handempty = true
    state.clear[x_idx] = true
    state.clear[y_idx] = false
    state.holding[x_idx] = false
    state.on[x_idx, y_idx] = true
    return state
end</code></pre><p>All of the above code is compiled from PDDL to Julia, which in turn gets compiled to high performance machine code by Julia&#39;s own compiler. By directly modifying the state representation, the compiled implementation can achieve median runtimes up to 60 times faster than the interpreted version of  <a href="../../ref/interface/#PDDL.execute"><code>execute</code></a>.</p><h2 id="Compiler-Limitations"><a class="docs-heading-anchor" href="#Compiler-Limitations">Compiler Limitations</a><a id="Compiler-Limitations-1"></a><a class="docs-heading-anchor-permalink" href="#Compiler-Limitations" title="Permalink"></a></h2><p>While domain compilation leads to significant performant benefits, the compiler also has several limitations in the current version of PDDL.jl:</p><ul><li><p><strong>Top-level only</strong>: Because <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> defines new types and methods, it should only be called at the top-level in order to avoid world-age errors.</p></li><li><p><strong>Precompilation not supported</strong>: Since <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> evaluates code in the <code>PDDL</code> module, it will lead to precompilation errors when used in another module or package. Modules which call <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> should hence disable precompilation, or include make calls to <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> only in the <a href="https://docs.julialang.org/en/v1/manual/modules/#Module-initialization-and-precompilation"><code>__init__()</code> function</a>.</p></li><li><p><strong>Regression not supported</strong>: The compiler does not currently implement the interface functions for reverse action semantics, meaning that it cannot be used for regression search.</p></li><li><p><strong>Compilation overhead</strong>: The cost of compiling generated Julia code on its first run can be significant relative to total runtime for small problems. This means that compilation may not be ideal for one-off use for states with small numbers of objects.</p></li><li><p><strong>No generalization across problems in the same domain</strong>: The compiled code and state representations generated by the compiler currently assume a fixed set of objects. To use the compiler with problems in the same domain, but defined over a different set of of objects the <a href="../../ref/compiler/#PDDL.compiled"><code>compiled</code></a> function has to be invoked again.</p></li></ul><p>Due to these limitations, it may sometimes be preferable to use the PDDL.jl interpreter instead of the compiler, especially when generality is more important than speed. However, most of these limitations are planned to be removed in future versions of PDDL.jl.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../writing_planners/">« Writing Planners</a><a class="docs-footer-nextpage" href="../extending/">Extending PDDL.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.28.0-DEV on <span class="colophon-date" title="Saturday 13 January 2024 21:04">Saturday 13 January 2024</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
